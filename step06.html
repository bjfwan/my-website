<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step06 - ç›´è¾¾è½¦æ¬¡æ˜¾ç¤º</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸš„ Step06 - ç›´è¾¾è½¦æ¬¡æ˜¾ç¤º</h1>
            <p class="subtitle"><a href="step05.html" style="color: #58a6ff;">â† Step05</a> | <a href="index.html" style="color: #58a6ff;">ä¸»é¡µ</a> | <a href="step07.html" style="color: #58a6ff;">Step07 â†’</a></p>
        </div>
    </header>

    <div class="container">
        <div class="info-box">
            <h3>ğŸ“‹ åŠŸèƒ½è¯´æ˜</h3>
            <ul>
                <li>âœ… åŒ…å«Step01-05æ‰€æœ‰åŠŸèƒ½</li>
                <li>âœ… è§£æç½‘ç»œè¿”å›çš„è½¦æ¬¡æ•°æ®</li>
                <li>âœ… æ˜¾ç¤ºè½¦æ¬¡åˆ—è¡¨ï¼ˆè½¦æ¬¡å·ã€æ—¶é—´ã€ç«™ç‚¹ï¼‰</li>
                <li>âœ… æ˜¾ç¤º"ç›´è¾¾"æ ‡è¯†</li>
                <li>ğŸ¯ åˆ†å€¼ï¼š5åˆ†</li>
            </ul>
        </div>

        <div class="file-block">
            <div class="file-header">
                <span class="file-name">ğŸ“„ Index.etsï¼ˆä¸Step05ç›¸åŒï¼‰</span>
                <button class="copy-btn" onclick="copyCode(this)">ğŸ“‹ å¤åˆ¶ä»£ç </button>
            </div>
            <pre><code class="language-typescript">import router from '@ohos.router'
import { resourceManager } from '@kit.LocalizationKit'
import { util } from '@kit.ArkTS'
import { CityModel } from '../model/CityModel'

@Entry
@Component
struct Index {
  @State startCity: string = 'è¯·é€‰æ‹©'
  @State endCity: string = 'è¯·é€‰æ‹©'
  @State selectedDate: string = this.getTodayDate()
  @State cityList: string[] = []
  @State showCityDialog: boolean = false
  @State selectType: string = ''

  async aboutToAppear() {
    await this.loadCityData()
  }

  getTodayDate(): string {
    const date = new Date()
    const year = date.getFullYear()
    const month = (date.getMonth() + 1).toString().padStart(2, '0')
    const day = date.getDate().toString().padStart(2, '0')
    return \`\${year}-\${month}-\${day}\`
  }

  async loadCityData() {
    try {
      const context = getContext(this)
      const mgr: resourceManager.ResourceManager = context.resourceManager
      const rawFileData: Uint8Array = await mgr.getRawFileContent('city.json')
      const textDecoder = util.TextDecoder.create('utf-8')
      const jsonStr: string = textDecoder.decodeToString(rawFileData)
      const cityModel: CityModel = JSON.parse(jsonStr)
      this.cityList = cityModel.cities
    } catch (error) {
      console.error('è¯»å–åŸå¸‚æ•°æ®å¤±è´¥:', error)
    }
  }

  openCityDialog(type: string) {
    this.selectType = type
    this.showCityDialog = true
  }

  selectCity(city: string) {
    if (this.selectType === 'start') {
      this.startCity = city
    } else {
      this.endCity = city
    }
    this.showCityDialog = false
  }

  queryTicket() {
    if (this.startCity === 'è¯·é€‰æ‹©' || this.endCity === 'è¯·é€‰æ‹©') {
      return
    }
    router.pushUrl({
      url: 'pages/DetailPage',
      params: {
        startCity: this.startCity,
        endCity: this.endCity,
        date: this.selectedDate
      }
    })
  }

  @Builder
  cityDialogBuilder() {
    Column() {
      Text('é€‰æ‹©åŸå¸‚')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .padding(15)

      List() {
        ForEach(this.cityList, (city: string) => {
          ListItem() {
            Text(city)
              .width('100%')
              .padding(15)
              .onClick(() => this.selectCity(city))
          }
        })
      }
      .height('80%')

      Button('å–æ¶ˆ')
        .width('90%')
        .margin({ top: 10, bottom: 10 })
        .onClick(() => this.showCityDialog = false)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
  }

  build() {
    Stack() {
      Column() {
        Text('ç«è½¦ç¥¨æŸ¥è¯¢')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 20, bottom: 30 })

        Column() {
          Row() {
            Text('å‡ºå‘åœ°')
              .width(80)
            Text(this.startCity)
              .layoutWeight(1)
              .textAlign(TextAlign.End)
            Image($r('app.media.startIcon'))
              .width(20)
              .height(20)
              .margin({ left: 10 })
          }
          .width('100%')
          .padding(15)
          .backgroundColor(Color.White)
          .borderRadius(8)
          .onClick(() => this.openCityDialog('start'))

          Row() {
            Text('ç›®çš„åœ°')
              .width(80)
            Text(this.endCity)
              .layoutWeight(1)
              .textAlign(TextAlign.End)
            Image($r('app.media.startIcon'))
              .width(20)
              .height(20)
              .margin({ left: 10 })
          }
          .width('100%')
          .padding(15)
          .backgroundColor(Color.White)
          .borderRadius(8)
          .margin({ top: 10 })
          .onClick(() => this.openCityDialog('end'))

          Row() {
            Text('å‡ºå‘æ—¥æœŸ')
              .width(80)
            Text(this.selectedDate)
              .layoutWeight(1)
              .textAlign(TextAlign.End)
            Image($r('app.media.startIcon'))
              .width(20)
              .height(20)
              .margin({ left: 10 })
          }
          .width('100%')
          .padding(15)
          .backgroundColor(Color.White)
          .borderRadius(8)
          .margin({ top: 10 })
          .onClick(() => {
            DatePickerDialog.show({
              start: new Date(),
              selected: new Date(this.selectedDate),
              onAccept: (value: DatePickerResult) => {
                const month = value.month !== undefined ? value.month + 1 : 1
                const day = value.day !== undefined ? value.day : 1
                this.selectedDate = \`\${value.year}-\${month.toString().padStart(2, '0')}-\${day.toString().padStart(2, '0')}\`
              }
            })
          })

          Button('æŸ¥è¯¢')
            .width('100%')
            .height(50)
            .fontSize(18)
            .margin({ top: 40 })
            .onClick(() => this.queryTicket())
        }
        .width('90%')
        .margin({ top: 20 })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')

      if (this.showCityDialog) {
        this.cityDialogBuilder()
      }
    }
    .width('100%')
    .height('100%')
  }
}</code></pre>
        </div>

        <div class="file-block">
            <div class="file-header">
                <span class="file-name">ğŸ“„ DetailPage.etsï¼ˆå®Œæ•´ä»£ç -æ˜¾ç¤ºè½¦æ¬¡åˆ—è¡¨ï¼‰</span>
                <button class="copy-btn" onclick="copyCode(this)">ğŸ“‹ å¤åˆ¶ä»£ç </button>
            </div>
            <pre><code class="language-typescript">import router from '@ohos.router'
import { HttpUtil } from '../utils/HttpUtil'

interface SeatInfo {
  seatType: string
  price: number
  status: string
}

interface TrainInfo {
  trainNo: string
  departTime: string
  arriveTime: string
  departStation: string
  arriveStation: string
  seats: SeatInfo[]
}

@Entry
@Component
struct DetailPage {
  @State startCity: string = ''
  @State endCity: string = ''
  @State date: string = ''
  @State trainList: TrainInfo[] = []
  @State isLoading: boolean = false

  aboutToAppear() {
    const params = router.getParams() as Record<string, string>
    this.startCity = params['startCity'] || ''
    this.endCity = params['endCity'] || ''
    this.date = params['date'] || ''
    this.queryTrainTicket()
  }

  async queryTrainTicket() {
    this.isLoading = true
    try {
      const result = await HttpUtil.queryTrainTicket(this.startCity, this.endCity, this.date)
      this.parseTrains(result)
    } catch (error) {
      console.error('æŸ¥è¯¢å¼‚å¸¸:', error)
      this.trainList = []
    }
    this.isLoading = false
  }

  parseTrains(message: string): void {
    try {
      let jsonStr = message.trim()
      const jsonMatch = jsonStr.match(/\\[\\s*\\{[\\s\\S]*\\}\\s*\\]/)
      if (jsonMatch) {
        jsonStr = jsonMatch[0]
      }
      
      const trainData: TrainInfo[] = JSON.parse(jsonStr) as TrainInfo[]
      this.trainList = trainData.filter(train => 
        train.trainNo && train.departTime && train.arriveTime
      )
    } catch (error) {
      console.error('è§£æå¤±è´¥:', error)
      this.trainList = []
    }
  }

  @Builder
  buildTrainCard(train: TrainInfo) {
    Column({ space: 12 }) {
      Row() {
        Text(train.trainNo)
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .layoutWeight(1)
      }
      .width('100%')

      Row() {
        Column({ space: 6 }) {
          Text(train.departTime || '--:--')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
          Text(train.departStation || this.startCity)
            .fontSize(14)
            .fontColor('#666666')
        }
        .layoutWeight(1)

        Column({ space: 4 }) {
          Text('â†’')
            .fontSize(18)
            .fontColor('#999999')
            .width(40)
            .textAlign(TextAlign.Center)
          Text('ç›´è¾¾')
            .fontSize(12)
            .fontColor('#95DE64')
            .textAlign(TextAlign.Center)
        }
        .width(40)
        .justifyContent(FlexAlign.Center)

        Column({ space: 6 }) {
          Text(train.arriveTime || '--:--')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
          Text(train.arriveStation || this.endCity)
            .fontSize(14)
            .fontColor('#666666')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.End)
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .margin({ bottom: 12 })
  }

  build() {
    Column() {
      Row() {
        Text('â†')
          .fontSize(24)
          .fontColor('#333333')
          .onClick(() => router.back())
        Text(\`\${this.startCity} â†’ \${this.endCity}\`)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        Text(this.date)
          .fontSize(12)
          .fontColor('#999999')
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFEFD5')

      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
          Text('æ­£åœ¨æŸ¥è¯¢ä¸­...')
            .fontSize(14)
            .fontColor('#999')
            .margin({ top: 10 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        Scroll() {
          Column({ space: 16 }) {
            if (this.trainList.length > 0) {
              ForEach(this.trainList, (train: TrainInfo) => {
                this.buildTrainCard(train)
              }, (train: TrainInfo) => train.trainNo)
            } else {
              Text('æš‚æ— æŸ¥è¯¢ç»“æœ')
                .fontSize(16)
                .fontColor('#999')
                .width('100%')
                .textAlign(TextAlign.Center)
                .padding(40)
            }
          }
          .width('100%')
          .padding(16)
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor('#F5F7FA')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}</code></pre>
        </div>

        <div class="file-block">
            <div class="file-header">
                <span class="file-name">ğŸ“„ HttpUtil.etsï¼ˆä¸Step05ç›¸åŒï¼‰</span>
                <button class="copy-btn" onclick="copyCode(this)">ğŸ“‹ å¤åˆ¶ä»£ç </button>
            </div>
            <pre><code class="language-typescript">import { http } from '@kit.NetworkKit'

interface RequestBody {
  query: string
}

class HttpUtilClass {
  private readonly BASE_URL: string = 'https://YOUR_API_URL'
  private readonly CONVERSATION_ID: string = 'YOUR_CONVERSATION_ID'
  private readonly VERSION: string = 'YOUR_VERSION'
  private readonly IAM_TOKEN: string = 'YOUR_IAM_TOKEN'

  async queryTrainTicket(startCity: string, endCity: string, date: string): Promise<string> {
    const url = \`\${this.BASE_URL}/conversations/\${this.CONVERSATION_ID}?version=\${this.VERSION}\`
    const requestBody: RequestBody = {
      query: \`æŸ¥è¯¢\${date}ä»\${startCity}åˆ°\${endCity}çš„è½¦ç¥¨ã€‚è¦æ±‚ï¼šå¿…é¡»ä»¥JSONæ•°ç»„æ ¼å¼è¿”å›ï¼Œæ¯ä¸ªè½¦æ¬¡åŒ…å«trainNo(è½¦æ¬¡å·)ã€departStation(å‡ºå‘ç«™)ã€departTime(å‡ºå‘æ—¶é—´HH:MM)ã€arriveStation(åˆ°è¾¾ç«™)ã€arriveTime(åˆ°è¾¾æ—¶é—´HH:MM)ã€seatsæ•°ç»„(åŒ…å«seatTypeåº§ä½ç±»å‹ã€priceä»·æ ¼ã€statusçŠ¶æ€)ã€‚åªè¿”å›JSONæ•°æ®ï¼Œä¸è¦å…¶ä»–æ–‡å­—è¯´æ˜ã€‚\`
    }

    const httpRequest = http.createHttp()
    
    try {
      httpRequest.on('dataReceive', () => {})
      
      const requestOptions: http.HttpRequestOptions = {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': 'application/json',
          'X-Auth-Token': this.IAM_TOKEN
        },
        extraData: JSON.stringify(requestBody),
        expectDataType: http.HttpDataType.STRING,
        connectTimeout: 60000,
        readTimeout: 60000,
        usingProtocol: http.HttpProtocol.HTTP1_1,
        remoteValidation: 'skip'
      }
      
      const response: http.HttpResponse = await httpRequest.request(url, requestOptions)

      if (response.responseCode === 200) {
        return response.result as string
      } else {
        return \`HTTPé”™è¯¯: \${response.responseCode}\`
      }
    } catch (error) {
      const errorObj = error as Record<string, Object>
      return \`ç½‘ç»œè¯·æ±‚å¤±è´¥: \${errorObj.message || 'æœªçŸ¥é”™è¯¯'}\`
    } finally {
      httpRequest.destroy()
    }
  }
}

export const HttpUtil = new HttpUtilClass()</code></pre>
        </div>

        <div class="file-block">
            <div class="file-header">
                <span class="file-name">ğŸ“„ CityModel.ets</span>
                <button class="copy-btn" onclick="copyCode(this)">ğŸ“‹ å¤åˆ¶ä»£ç </button>
            </div>
            <pre><code class="language-typescript">export class CityModel {
  cities: string[] = []
}</code></pre>
        </div>

        <div class="info-box" style="margin-top: 30px;">
            <h3>ğŸ’¡ ä½¿ç”¨æç¤º</h3>
            <p>1. Index.etsä¿æŒä¸Step05ç›¸åŒ</p>
            <p>2. ç”¨æœ¬é¡µçš„ <strong>DetailPage.ets</strong> æ›¿æ¢Step05çš„DetailPage.ets</p>
            <p>3. HttpUtil.etsä¿æŒä¸å˜ï¼ˆç¡®ä¿å·²é…ç½®å¥½APIå‚æ•°ï¼‰</p>
            <p>4. è¿è¡Œé¡¹ç›®æŸ¥çœ‹è½¦æ¬¡åˆ—è¡¨å±•ç¤ºæ•ˆæœ</p>
        </div>
    </div>

    <footer>
        <p><a href="step05.html">â† Step05</a> | <a href="index.html">è¿”å›ä¸»é¡µ</a> | <a href="step07.html">Step07 â†’</a></p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
    <script src="script.js"></script>
</body>
</html>
