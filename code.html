<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«è½¦ç¥¨æŸ¥è¯¢ - HarmonyOSé¡¹ç›®ä»£ç </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="code-style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1>ğŸš„ ç«è½¦ç¥¨æŸ¥è¯¢ - HarmonyOSé¡¹ç›®</h1>
            <a href="index.html" class="home-link">è¿”å›é¦–é¡µ</a>
        </div>
    </nav>

    <div class="container">
        <div class="project-info">
            <h2>é¡¹ç›®ä»‹ç»</h2>
            <p>è¿™æ˜¯ä¸€ä¸ªåŸºäº <strong>HarmonyOS</strong> å¼€å‘çš„ç«è½¦ç¥¨æŸ¥è¯¢åº”ç”¨ï¼Œä½¿ç”¨ <strong>ArkTS</strong> è¯­è¨€ç¼–å†™ã€‚</p>
            <p><strong>âœ… å®Œæ•´å®ç°å…¨éƒ¨13é¡¹æ¯”èµ›è¦æ±‚ï¼ˆæ»¡åˆ†55åˆ†ï¼‰</strong></p>
            <ul>
                <li>âœ… <strong>è¦æ±‚1ï¼ˆ10åˆ†ï¼‰</strong>ï¼šå‡ºå‘åœ°ã€ç›®çš„åœ°åŠŸèƒ½ - è¯»å–city.jsonã€å¼¹æ¡†é€‰æ‹©ã€æ˜¾ç¤ºç»“æœ</li>
                <li>âœ… <strong>è¦æ±‚2ï¼ˆ5åˆ†ï¼‰</strong>ï¼šæ—¥æœŸé€‰æ‹©åŠŸèƒ½ - DatePickerDialogå®ç°</li>
                <li>âœ… <strong>è¦æ±‚3ï¼ˆ3åˆ†ï¼‰</strong>ï¼šæŸ¥è¯¢è¯¦æƒ…æ ‡é¢˜åŠŸèƒ½ - routerä¼ é€’startCity/endCity</li>
                <li>âœ… <strong>è¦æ±‚4ï¼ˆ3åˆ†ï¼‰</strong>ï¼šæŸ¥è¯¢è¯¦æƒ…æ—¥æœŸåŠŸèƒ½ - routerä¼ é€’date</li>
                <li>âœ… <strong>è¦æ±‚5ï¼ˆ5åˆ†ï¼‰</strong>ï¼šæŸ¥è¯¢ç»“æœåŠŸèƒ½ - HTTPè¯·æ±‚åä¸ºAI Agent</li>
                <li>âœ… <strong>è¦æ±‚6ï¼ˆ5åˆ†ï¼‰</strong>ï¼šç›´è¾¾è½¦æ¬¡åŠŸèƒ½ - æ˜¾ç¤ºè½¦æ¬¡å·å’Œç›´è¾¾æ ‡è¯†</li>
                <li>âœ… <strong>è¦æ±‚7ï¼ˆ2åˆ†ï¼‰</strong>ï¼šç¥¨ä»·å‚è€ƒåŠŸèƒ½ - æ˜¾ç¤ºåº§ä½ç±»å‹å’Œä»·æ ¼</li>
                <li>âœ… <strong>è¦æ±‚8ï¼ˆ3åˆ†ï¼‰</strong>ï¼šä½™ç¥¨æƒ…å†µåŠŸèƒ½ - æ˜¾ç¤ºæœ‰ç¥¨/æ— ç¥¨çŠ¶æ€</li>
                <li>âœ… <strong>è¦æ±‚9ï¼ˆ4åˆ†ï¼‰</strong>ï¼šæ¸©é¦¨æç¤ºåŠŸèƒ½ - æ˜¾ç¤º"ä»…ä¾›å‚è€ƒ"æç¤º</li>
                <li>âœ… <strong>è¦æ±‚10ï¼ˆ4åˆ†ï¼‰</strong>ï¼šå…¬å…±äº‹ä»¶ä¸é€šçŸ¥åŠŸèƒ½ - æ‰“å¼€APPæ¨é€é€šçŸ¥</li>
                <li>âœ… <strong>è¦æ±‚11ï¼ˆ3åˆ†ï¼‰</strong>ï¼šæ•°æ®ç®¡ç†åŠŸèƒ½ - Preferencesæœ¬åœ°å­˜å‚¨</li>
                <li>âœ… <strong>è¦æ±‚12ï¼ˆ3åˆ†ï¼‰</strong>ï¼šç”µè¯æœåŠ¡åŠŸèƒ½ - æ‹¨æ‰“12306ç”µè¯</li>
                <li>âœ… <strong>è¦æ±‚13ï¼ˆ5åˆ†ï¼‰</strong>ï¼šWEBåŠŸèƒ½ - è·³è½¬12306å®˜ç½‘</li>
            </ul>
        </div>

        <div class="file-tabs">
            <button class="tab active" data-file="index">Index.ets - ä¸»é¡µé¢</button>
            <button class="tab" data-file="detail">DetailPage.ets - è¯¦æƒ…é¡µ</button>
            <button class="tab" data-file="http">HttpUtil.ets - ç½‘ç»œå·¥å…·</button>
            <button class="tab" data-file="preferences">PreferencesUtil.ets - æ•°æ®ç®¡ç†</button>
            <button class="tab" data-file="ability">EntryAbility.ets - é€šçŸ¥åŠŸèƒ½</button>
            <button class="tab" data-file="web">WebPage.ets - ç½‘é¡µåŠŸèƒ½</button>
            <button class="tab" data-file="model">CityModel.ets - æ•°æ®æ¨¡å‹</button>
        </div>

        <div class="code-container" id="code-index" style="display: block;">
            <h3>Index.ets - ä¸»é¡µé¢</h3>
            <p class="file-desc">âœ… åŒ…å«è¦æ±‚1ã€2ã€3ã€4ã€11ï¼šå‡ºå‘åœ°ç›®çš„åœ°é€‰æ‹©ã€æ—¥æœŸé€‰æ‹©ã€æ•°æ®ä¼ é€’ã€æœ¬åœ°å­˜å‚¨</p>
            <pre><code class="language-typescript">import router from '@ohos.router'
import { resourceManager } from '@kit.LocalizationKit'
import { util } from '@kit.ArkTS'
import { CityModel } from '../model/CityModel'
import { PreferencesUtil } from '../utils/PreferencesUtil'

@Entry
@Component
struct Index {
  // ========== æ¯”èµ›è¦æ±‚1ï¼šå‡ºå‘åœ°ã€ç›®çš„åœ°åŠŸèƒ½ï¼ˆ10åˆ†ï¼‰ ==========
  // çŠ¶æ€å˜é‡å®šä¹‰
  @State startCity: string = 'è¯·é€‰æ‹©'
  @State endCity: string = 'è¯·é€‰æ‹©'
  @State selectedDate: string = this.getTodayDate()
  @State cityList: string[] = []
  @State showCityDialog: boolean = false
  @State selectType: string = ''

  async aboutToAppear() {
    await this.loadCityData()
    await this.loadSavedData()
  }

  getTodayDate(): string {
    const date = new Date()
    const year = date.getFullYear()
    const month = (date.getMonth() + 1).toString().padStart(2, '0')
    const day = date.getDate().toString().padStart(2, '0')
    return \`\${year}-\${month}-\${day}\`
  }

  // ========== æ¯”èµ›è¦æ±‚1ï¼šè¯»å–city.jsonæ–‡ä»¶ï¼ˆ10åˆ†ï¼‰ ==========
  async loadCityData() {
    try {
      const context = getContext(this)
      const mgr: resourceManager.ResourceManager = context.resourceManager
      // è¯»å–rawfileä¸­çš„city.jsonæ–‡ä»¶
      const rawFileData: Uint8Array = await mgr.getRawFileContent('city.json')
      const textDecoder = util.TextDecoder.create('utf-8')
      const jsonStr: string = textDecoder.decodeToString(rawFileData)
      // JSONè§£ææˆå®ä½“å¯¹è±¡
      const cityModel: CityModel = JSON.parse(jsonStr)
      // è·å–åŸå¸‚æ•°ç»„
      this.cityList = cityModel.cities
    } catch (error) {
      console.error('è¯»å–åŸå¸‚æ•°æ®å¤±è´¥:', error)
    }
  }

  // ========== æ¯”èµ›è¦æ±‚11ï¼šæ•°æ®ç®¡ç†åŠŸèƒ½ï¼ˆ3åˆ†ï¼‰ ==========
  // ä»æœ¬åœ°æ•°æ®åº“è¯»å–ä¿å­˜çš„åŸå¸‚ä¿¡æ¯
  async loadSavedData() {
    const savedStart = await PreferencesUtil.getCity('startCity')
    const savedEnd = await PreferencesUtil.getCity('endCity')
    if (savedStart) {
      this.startCity = savedStart
    }
    if (savedEnd) {
      this.endCity = savedEnd
    }
  }

  // ========== æ¯”èµ›è¦æ±‚1ï¼šå¼¹æ¡†æ˜¾ç¤ºåŸå¸‚åˆ—è¡¨ï¼ˆ10åˆ†ï¼‰ ==========
  openCityDialog(type: string) {
    this.selectType = type
    this.showCityDialog = true
  }

  // ========== æ¯”èµ›è¦æ±‚1 + 11ï¼šé€‰æ‹©åŸå¸‚å¹¶ä¿å­˜ï¼ˆ10åˆ† + 3åˆ†ï¼‰ ==========
  async selectCity(city: string) {
    if (this.selectType === 'start') {
      this.startCity = city
      // å°†åŸå¸‚ä¿¡æ¯å­˜å‚¨åˆ°æœ¬åœ°æ•°æ®åº“
      await PreferencesUtil.saveCity('startCity', city)
    } else {
      this.endCity = city
      await PreferencesUtil.saveCity('endCity', city)
    }
    this.showCityDialog = false
  }

  // ========== æ¯”èµ›è¦æ±‚3ã€4ï¼šä¼ é€’æ ‡é¢˜å’Œæ—¥æœŸæ•°æ®ï¼ˆ3åˆ† + 3åˆ†ï¼‰ ==========
  queryTicket() {
    if (this.startCity === 'è¯·é€‰æ‹©' || this.endCity === 'è¯·é€‰æ‹©') {
      return
    }
    router.pushUrl({
      url: 'pages/DetailPage',
      params: {
        startCity: this.startCity,  // ä¼ é€’æ ‡é¢˜æ•°æ®
        endCity: this.endCity,
        date: this.selectedDate      // ä¼ é€’æ—¥æœŸæ•°æ®
      }
    })
  }

  @Builder
  cityDialogBuilder() {
    Column() {
      Text('é€‰æ‹©åŸå¸‚')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .padding(15)

      List() {
        ForEach(this.cityList, (city: string) => {
          ListItem() {
            Text(city)
              .width('100%')
              .padding(15)
              .onClick(() => this.selectCity(city))
          }
        })
      }
      .height('80%')

      Button('å–æ¶ˆ')
        .width('90%')
        .margin({ top: 10, bottom: 10 })
        .onClick(() => this.showCityDialog = false)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
  }

  build() {
    Stack() {
      Column() {
        Text('ç«è½¦ç¥¨æŸ¥è¯¢')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 20, bottom: 30 })

        Column() {
          Row() {
            Text('å‡ºå‘åœ°')
              .width(80)
            Text(this.startCity)
              .layoutWeight(1)
              .textAlign(TextAlign.End)
            Image($r('app.media.startIcon'))
              .width(20)
              .height(20)
              .margin({ left: 10 })
          }
          .width('100%')
          .padding(15)
          .backgroundColor(Color.White)
          .borderRadius(8)
          .onClick(() => this.openCityDialog('start'))

          Row() {
            Text('ç›®çš„åœ°')
              .width(80)
            Text(this.endCity)
              .layoutWeight(1)
              .textAlign(TextAlign.End)
            Image($r('app.media.startIcon'))
              .width(20)
              .height(20)
              .margin({ left: 10 })
          }
          .width('100%')
          .padding(15)
          .backgroundColor(Color.White)
          .borderRadius(8)
          .margin({ top: 10 })
          .onClick(() => this.openCityDialog('end'))

          Row() {
            Text('å‡ºå‘æ—¥æœŸ')
              .width(80)
            Text(this.selectedDate)
              .layoutWeight(1)
              .textAlign(TextAlign.End)
            Image($r('app.media.startIcon'))
              .width(20)
              .height(20)
              .margin({ left: 10 })
          }
          .width('100%')
          .padding(15)
          .backgroundColor(Color.White)
          .borderRadius(8)
          .margin({ top: 10 })
          .onClick(() => {
            // ========== æ¯”èµ›è¦æ±‚2ï¼šæ—¥æœŸé€‰æ‹©åŠŸèƒ½ï¼ˆ5åˆ†ï¼‰ ==========
            DatePickerDialog.show({
              start: new Date(),
              selected: new Date(this.selectedDate),
              onAccept: (value: DatePickerResult) => {
                const month = value.month !== undefined ? value.month + 1 : 1
                const day = value.day !== undefined ? value.day : 1
                this.selectedDate = \`\${value.year}-\${month.toString().padStart(2, '0')}-\${day.toString().padStart(2, '0')}\`
              }
            })
          })
        }
        .width('90%')
        .margin({ top: 20 })

        Button('æŸ¥è¯¢')
          .width('90%')
          .height(50)
          .fontSize(18)
          .margin({ top: 40 })
          .onClick(() => this.queryTicket())
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')

      if (this.showCityDialog) {
        this.cityDialogBuilder()
      }
    }
    .width('100%')
    .height('100%')
  }
}</code></pre>
        </div>

        <div class="code-container" id="code-detail" style="display: none;">
            <h3>DetailPage.ets - è¯¦æƒ…é¡µé¢</h3>
            <p class="file-desc">âœ… åŒ…å«è¦æ±‚3ã€4ã€5ã€6ã€7ã€8ã€9ã€12ã€13ï¼šæŸ¥è¯¢è¯¦æƒ…ã€ç½‘ç»œè¯·æ±‚ã€ç›´è¾¾è½¦æ¬¡ã€ç¥¨ä»·ã€ä½™ç¥¨ã€æ¸©é¦¨æç¤ºã€ç”µè¯ã€ç½‘é¡µ</p>
            <pre><code class="language-typescript">import router from '@ohos.router'
import { HttpUtil } from '../utils/HttpUtil'
import call from '@ohos.telephony.call'

interface SeatInfo {
  seatType: string
  price: number
  status: string
}

interface TrainInfo {
  trainNo: string
  departTime: string
  arriveTime: string
  departStation: string
  arriveStation: string
  seats: SeatInfo[]
}

@Entry
@Component
struct DetailPage {
  @State startCity: string = ''
  @State endCity: string = ''
  @State date: string = ''
  @State trainList: TrainInfo[] = []
  @State isLoading: boolean = false

  // ========== æ¯”èµ›è¦æ±‚3ã€4ï¼šè·å–æ ‡é¢˜å’Œæ—¥æœŸæ•°æ®ï¼ˆ3åˆ† + 3åˆ†ï¼‰ ==========
  aboutToAppear() {
    const params = router.getParams() as Record<string, string>
    this.startCity = params['startCity'] || ''  // ä»é¦–é¡µè·å–æ ‡é¢˜æ•°æ®
    this.endCity = params['endCity'] || ''
    this.date = params['date'] || ''            // ä»é¦–é¡µè·å–æ—¥æœŸæ•°æ®
    this.queryTrainTicket()
  }

  // ========== æ¯”èµ›è¦æ±‚5ï¼šæŸ¥è¯¢ç»“æœåŠŸèƒ½ï¼ˆ5åˆ†ï¼‰ ==========
  // é€šè¿‡ç½‘ç»œè¯·æ±‚ä»åä¸ºAI Agentè·å–ç«è½¦ç¥¨ä¿¡æ¯
  async queryTrainTicket() {
    this.isLoading = true
    try {
      const result = await HttpUtil.queryTrainTicket(this.startCity, this.endCity, this.date)
      
      if (result.includes('HTTPé”™è¯¯') || result.includes('ç½‘ç»œè¯·æ±‚å¤±è´¥')) {
        this.trainList = []
        this.isLoading = false
        return
      }
      
      const fullMessage = this.extractSSEContent(result)
      this.parseTrains(fullMessage)
    } catch (error) {
      console.error('æŸ¥è¯¢å¼‚å¸¸:', error)
      this.trainList = []
    }
    this.isLoading = false
  }

  extractSSEContent(sseData: string): string {
    const lines: string[] = sseData.split('\\n')
    let fullMessage: string = ''
    
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim()
      if (line.startsWith('data:')) {
        const jsonStr: string = line.substring(5).trim()
        if (jsonStr && jsonStr !== '[DONE]') {
          try {
            const jsonData = JSON.parse(jsonStr) as Record<string, Object>
            if (jsonData.event === 'message' && jsonData.content) {
              fullMessage += String(jsonData.content)
            }
          } catch (e) {}
        }
      }
    }
    return fullMessage
  }

  parseTrains(message: string): void {
    try {
      if (!message || message.trim().length === 0) {
        this.trainList = []
        return
      }
      
      let jsonStr = message.trim()
      const jsonMatch = jsonStr.match(/\\[\\s*\\{[\\s\\S]*\\}\\s*\\]/)
      if (jsonMatch) {
        jsonStr = jsonMatch[0]
      }
      
      let trainData: TrainInfo[] = []
      
      try {
        trainData = JSON.parse(jsonStr) as TrainInfo[]
      } catch (e) {
        const converted = this.convertTextToJson(message)
        trainData = JSON.parse(converted) as TrainInfo[]
      }
      
      this.trainList = trainData.filter(train => 
        train.trainNo && train.departTime && train.arriveTime
      )
    } catch (error) {
      console.error('è§£æå¤±è´¥:', error)
      this.trainList = []
    }
  }

  // ========== æ¯”èµ›è¦æ±‚12ï¼šç”µè¯æœåŠ¡åŠŸèƒ½ï¼ˆ3åˆ†ï¼‰ ==========
  // ç‚¹å‡»ç”µè¯å·ç è·³è½¬åˆ°æ‹¨æ‰“ç”µè¯ç•Œé¢
  async makePhoneCall(phoneNumber: string) {
    try {
      await call.makeCall(phoneNumber)
    } catch (e) {}
  }

  // ========== æ¯”èµ›è¦æ±‚13ï¼šWEBåŠŸèƒ½ï¼ˆ5åˆ†ï¼‰ ==========
  // ç‚¹å‡»12306å®˜ç½‘è·³è½¬åˆ°12306é¦–é¡µ
  openWebPage() {
    router.pushUrl({
      url: 'pages/WebPage',
      params: {
        url: 'https://www.12306.cn'
      }
    })
  }

  @Builder
  buildTrainCard(train: TrainInfo) {
    Column({ space: 12 }) {
      // ========== æ¯”èµ›è¦æ±‚6ï¼šç›´è¾¾è½¦æ¬¡åŠŸèƒ½ï¼ˆ5åˆ†ï¼‰ ==========
      Row() {
        Text(train.trainNo)  // æ˜¾ç¤ºè½¦æ¬¡å·
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .layoutWeight(1)

        // ========== æ¯”èµ›è¦æ±‚8ï¼šä½™ç¥¨æƒ…å†µåŠŸèƒ½ï¼ˆ3åˆ†ï¼‰ ==========
        Text(train.seats.some(s => s.status.includes('æœ‰ç¥¨')) ? 'æœ‰ç¥¨' : 'æŸ¥è¯¢ä¸­')
          .fontSize(13)
          .fontColor(train.seats.some(s => s.status.includes('æœ‰ç¥¨')) ? '#52C41A' : '#999999')
          .fontWeight(FontWeight.Medium)
      }
      .width('100%')

      Row() {
        Column({ space: 6 }) {
          Text(train.departTime || '--:--')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
          Text(train.departStation || this.startCity)
            .fontSize(14)
            .fontColor('#666666')
        }
        .layoutWeight(1)

        // ========== æ¯”èµ›è¦æ±‚6ï¼šç›´è¾¾è½¦æ¬¡æ˜¾ç¤ºï¼ˆ5åˆ†ï¼‰ ==========
        Column({ space: 4 }) {
          Text('â†’')
            .fontSize(18)
            .fontColor('#999999')
          Text('ç›´è¾¾')  // æ˜¾ç¤ºç›´è¾¾è½¦æ¬¡æ ‡è¯†
            .fontSize(12)
            .fontColor('#95DE64')
        }

        Column({ space: 6 }) {
          Text(train.arriveTime || '--:--')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
          Text(train.arriveStation || this.endCity)
            .fontSize(14)
            .fontColor('#666666')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.End)
      }
      .width('100%')

      // ========== æ¯”èµ›è¦æ±‚7ï¼šç¥¨ä»·å‚è€ƒåŠŸèƒ½ï¼ˆ2åˆ†ï¼‰ ==========
      Column({ space: 8 }) {
        ForEach(train.seats || [], (seat: SeatInfo) => {
          Text(\`\${seat.seatType} Â¥\${seat.price} \${seat.status}\`)  // æ˜¾ç¤ºåº§ä½ç±»å‹å’Œç¥¨ä»·
            .fontSize(14)
            .fontColor(seat.status.includes('æœ‰ç¥¨') ? '#52C41A' : '#666666')
        }, (seat: SeatInfo, index: number) => index.toString())
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .margin({ bottom: 12 })
  }

  build() {
    Column() {
      // ========== æ¯”èµ›è¦æ±‚3ã€4ï¼šæ˜¾ç¤ºæ ‡é¢˜å’Œæ—¥æœŸï¼ˆ3åˆ† + 3åˆ†ï¼‰ ==========
      Row() {
        Text('â†')
          .fontSize(24)
          .onClick(() => router.back())
        Text(\`\${this.startCity} â†’ \${this.endCity}\`)  // æ˜¾ç¤ºæŸ¥è¯¢è¯¦æƒ…æ ‡é¢˜
          .fontSize(18)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        Text(this.date)  // æ˜¾ç¤ºæŸ¥è¯¢æ—¥æœŸ
          .fontSize(12)
      }
      .width('100%')
      .padding(16)

      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
          Text('æ­£åœ¨æŸ¥è¯¢ä¸­...')
            .fontSize(14)
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        Scroll() {
          Column({ space: 16 }) {
            if (this.trainList.length > 0) {
              ForEach(this.trainList, (train: TrainInfo) => {
                this.buildTrainCard(train)
              }, (train: TrainInfo) => train.trainNo)
            } else {
              Text('æš‚æ— æŸ¥è¯¢ç»“æœ')
                .fontSize(16)
                .padding(40)
            }
          }
        }
        .layoutWeight(1)
      }

      // ========== æ¯”èµ›è¦æ±‚12ã€13ï¼šç”µè¯æœåŠ¡å’ŒWEBåŠŸèƒ½ï¼ˆ3åˆ† + 5åˆ†ï¼‰ ==========
      Row() {
        Button('æ‹¨æ‰“12306')  // ç”µè¯æœåŠ¡åŠŸèƒ½
          .width('45%')
          .onClick(() => this.makePhoneCall('12306'))

        Button('è®¿é—®å®˜ç½‘')  // WEBåŠŸèƒ½
          .width('45%')
          .onClick(() => this.openWebPage())
      }
      .width('90%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ top: 15, bottom: 15 })
    }
    .width('100%')
    .height('100%')
  }
}</code></pre>
        </div>

        <div class="code-container" id="code-http" style="display: none;">
            <h3>HttpUtil.ets - HTTP ç½‘ç»œè¯·æ±‚å·¥å…·</h3>
            <p class="file-desc">âœ… åŒ…å«è¦æ±‚5ï¼šé€šè¿‡ç½‘ç»œè¯·æ±‚ä»åä¸ºAI Agentè·å–ç«è½¦ç¥¨ä¿¡æ¯</p>
            <pre><code class="language-typescript">import { http } from '@kit.NetworkKit'

interface RequestBody {
  query: string
}

// ========== æ¯”èµ›è¦æ±‚5ï¼šæŸ¥è¯¢ç»“æœåŠŸèƒ½ï¼ˆ5åˆ†ï¼‰ ==========
// ç½‘ç»œè¯·æ±‚å·¥å…·ç±»ï¼Œä»åä¸ºå¼€å‘è€…ç©ºé—´AI Agentè·å–æ•°æ®
class HttpUtilClass {
  // åä¸ºå¼€å‘è€…ç©ºé—´AI Agentçš„é…ç½®ä¿¡æ¯
  private readonly BASE_URL: string = 'https://123.249.99.67/v1/63a98ecdb3b6488ea881cf4f85b3db7a/agents/4e84b914-a787-4674-99b1-6310830bcb9f'
  private readonly CONVERSATION_ID: string = '38a2d783-b5b6-4e2e-94ae-d766f0babf0a'
  private readonly VERSION: string = '1762149260703'
  private readonly IAM_TOKEN: string = 'MIINcQYJKoZIhvcNAQcCoIINYjCCDV4CAQExDTALBglghkgBZQMEAgEw...'

  // æŸ¥è¯¢ç«è½¦ç¥¨çš„ç½‘ç»œè¯·æ±‚æ–¹æ³•
  async queryTrainTicket(startCity: string, endCity: string, date: string): Promise<string> {
    const url = \`\${this.BASE_URL}/conversations/\${this.CONVERSATION_ID}?version=\${this.VERSION}\`
    const requestBody: RequestBody = {
      query: \`æŸ¥è¯¢\${date}ä»\${startCity}åˆ°\${endCity}çš„è½¦ç¥¨ã€‚è¦æ±‚ï¼šå¿…é¡»ä»¥JSONæ•°ç»„æ ¼å¼è¿”å›ï¼Œæ¯ä¸ªè½¦æ¬¡åŒ…å«trainNo(è½¦æ¬¡å·)ã€departStation(å‡ºå‘ç«™)ã€departTime(å‡ºå‘æ—¶é—´HH:MM)ã€arriveStation(åˆ°è¾¾ç«™)ã€arriveTime(åˆ°è¾¾æ—¶é—´HH:MM)ã€seatsæ•°ç»„(åŒ…å«seatTypeåº§ä½ç±»å‹ã€priceä»·æ ¼ã€statusçŠ¶æ€)ã€‚åªè¿”å›JSONæ•°æ®ï¼Œä¸è¦å…¶ä»–æ–‡å­—è¯´æ˜ã€‚\`
    }

    const httpRequest = http.createHttp()
    
    try {
      httpRequest.on('dataReceive', () => {})
      
      // é…ç½®HTTPè¯·æ±‚é€‰é¡¹
      const requestOptions: http.HttpRequestOptions = {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': 'application/json',
          'X-Auth-Token': this.IAM_TOKEN  // ä½¿ç”¨IAM Tokenè®¤è¯
        },
        extraData: JSON.stringify(requestBody),
        expectDataType: http.HttpDataType.STRING,
        connectTimeout: 60000,
        readTimeout: 60000,
        usingProtocol: http.HttpProtocol.HTTP1_1,
        remoteValidation: 'skip'
      }
      
      // å‘é€ç½‘ç»œè¯·æ±‚åˆ°åä¸ºAI Agent
      const response: http.HttpResponse = await httpRequest.request(url, requestOptions)

      if (response.responseCode === 200) {
        return response.result as string
      } else {
        return \`HTTPé”™è¯¯: \${response.responseCode}\`
      }
    } catch (error) {
      const errorObj = error as Record<string, Object>
      return \`ç½‘ç»œè¯·æ±‚å¤±è´¥: \${errorObj.message || 'æœªçŸ¥é”™è¯¯'}\`
    } finally {
      httpRequest.destroy()
    }
  }
}

export const HttpUtil = new HttpUtilClass()</code></pre>
        </div>

        <div class="code-container" id="code-preferences" style="display: none;">
            <h3>PreferencesUtil.ets - æ•°æ®ç®¡ç†å·¥å…·</h3>
            <p class="file-desc">âœ… åŒ…å«è¦æ±‚11ï¼šå°†åŸå¸‚é€‰æ‹©ä¿¡æ¯å­˜å‚¨åˆ°æœ¬åœ°æ•°æ®åº“</p>
            <pre><code class="language-typescript">import { preferences } from '@kit.ArkData'
import { Context } from '@kit.AbilityKit'

// ========== æ¯”èµ›è¦æ±‚11ï¼šæ•°æ®ç®¡ç†åŠŸèƒ½ï¼ˆ3åˆ†ï¼‰ ==========
// ä½¿ç”¨Preferenceså®ç°æœ¬åœ°æ•°æ®å­˜å‚¨
class PreferencesUtilClass {
  private dataPreferences: preferences.Preferences | null = null

  // åˆå§‹åŒ–Preferencesæ•°æ®åº“
  async initPreferences(context: Context): Promise<void> {
    try {
      this.dataPreferences = await preferences.getPreferences(context, 'trainTicketData')
    } catch (error) {
      console.error('åˆå§‹åŒ–å¤±è´¥:', JSON.stringify(error))
    }
  }

  // ä¿å­˜åŸå¸‚ä¿¡æ¯åˆ°æœ¬åœ°æ•°æ®åº“
  async saveCity(key: string, value: string): Promise<void> {
    if (this.dataPreferences) {
      await this.dataPreferences.put(key, value)
      await this.dataPreferences.flush()  // æŒä¹…åŒ–æ•°æ®
    }
  }

  // ä»æœ¬åœ°æ•°æ®åº“è¯»å–åŸå¸‚ä¿¡æ¯
  async getCity(key: string): Promise<string> {
    if (this.dataPreferences) {
      return await this.dataPreferences.get(key, '') as string
    }
    return ''
  }
}

export const PreferencesUtil = new PreferencesUtilClass()</code></pre>
        </div>

        <div class="code-container" id="code-ability" style="display: none;">
            <h3>EntryAbility.ets - åº”ç”¨å…¥å£ä¸é€šçŸ¥</h3>
            <p class="file-desc">âœ… åŒ…å«è¦æ±‚10ï¼šæ‰“å¼€APPæ—¶æ¨é€é€šçŸ¥</p>
            <pre><code class="language-typescript">import { AbilityConstant, UIAbility, Want } from '@kit.AbilityKit'
import { hilog } from '@kit.PerformanceAnalysisKit'
import { window } from '@kit.ArkUI'
import { notificationManager } from '@kit.NotificationKit'
import { PreferencesUtil } from '../utils/PreferencesUtil'

const DOMAIN = 0x0000

export default class EntryAbility extends UIAbility {
  onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {    
  }

  onDestroy(): void { 
  }

  async onWindowStageCreate(windowStage: window.WindowStage): Promise<void> {    
    // åˆå§‹åŒ–æœ¬åœ°æ•°æ®åº“
    await PreferencesUtil.initPreferences(this.context)    

    // ========== æ¯”èµ›è¦æ±‚10ï¼šå…¬å…±äº‹ä»¶ä¸é€šçŸ¥åŠŸèƒ½ï¼ˆ4åˆ†ï¼‰ ==========
    // æ‰“å¼€APPæ—¶æ¨é€é€šçŸ¥
    this.publishNotification()   

    windowStage.loadContent('pages/Index', (err) => {
      if (err.code) {
        hilog.error(DOMAIN, 'testTag', 'Failed to load the content. Cause: %{public}s', JSON.stringify(err))
        return
      }
    })
  }

  // ========== æ¯”èµ›è¦æ±‚10ï¼šæ¨é€é€šçŸ¥å®ç°ï¼ˆ4åˆ†ï¼‰ ==========
  async publishNotification(): Promise<void> {
    try {
      const notificationRequest: notificationManager.NotificationRequest = {
        id: 1,
        content: {
          notificationContentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
          normal: {
            title: 'ç«è½¦ç¥¨æŸ¥è¯¢',
            text: 'æ¬¢è¿ä½¿ç”¨ç«è½¦ç¥¨æŸ¥è¯¢ç³»ç»Ÿ'  // é€šçŸ¥å†…å®¹
          }
        }
      }
      // å‘å¸ƒé€šçŸ¥
      await notificationManager.publish(notificationRequest)
    } catch (error) {
      hilog.error(DOMAIN, 'testTag', 'Failed to publish notification: %{public}s', JSON.stringify(error))
    }
  }

  onWindowStageDestroy(): void {   
  }

  onForeground(): void {    
  }

  onBackground(): void {
  }
}</code></pre>
        </div>

        <div class="code-container" id="code-web" style="display: none;">
            <h3>WebPage.ets - ç½‘é¡µæµè§ˆåŠŸèƒ½</h3>
            <p class="file-desc">âœ… åŒ…å«è¦æ±‚13ï¼šç‚¹å‡»12306å®˜ç½‘åè·³è½¬åˆ°12306é¦–é¡µ</p>
            <pre><code class="language-typescript">import router from '@ohos.router'
import { webview } from '@kit.ArkWeb'

// ========== æ¯”èµ›è¦æ±‚13ï¼šWEBåŠŸèƒ½ï¼ˆ5åˆ†ï¼‰ ==========
// å®ç°ç½‘é¡µæµè§ˆåŠŸèƒ½ï¼Œè·³è½¬åˆ°12306å®˜ç½‘
@Entry
@Component
struct WebPage {
  @State url: string = ''
  webController: webview.WebviewController = new webview.WebviewController()

  aboutToAppear() {
    const params = router.getParams() as Record<string, string>
    this.url = params['url'] || 'https://www.12306.cn'  // è·å–è¦è®¿é—®çš„ç½‘å€
  }

  build() {
    Column() {
      Row() {
        Text('â†')
          .fontSize(24)
          .onClick(() => router.back())
        Text('ç½‘é¡µæµè§ˆ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .padding(15)
      .backgroundColor(Color.White)

      // ä½¿ç”¨Webç»„ä»¶æ˜¾ç¤º12306å®˜ç½‘
      Web({ src: this.url, controller: this.webController })
        .width('100%')
        .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
  }
}</code></pre>
        </div>

        <div class="code-container" id="code-model" style="display: none;">
            <h3>CityModel.ets - åŸå¸‚æ•°æ®æ¨¡å‹</h3>
            <p class="file-desc">å®šä¹‰åŸå¸‚åˆ—è¡¨çš„æ•°æ®ç»“æ„</p>
            <pre><code class="language-typescript">export class CityModel {
  cities: string[] = []
}</code></pre>
        </div>
    </div>

    <footer>
        <p>Â© 2024 HarmonyOS ç«è½¦ç¥¨æŸ¥è¯¢é¡¹ç›® | æ‰˜ç®¡åœ¨ Cloudflare Pages</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
    <script src="code-script.js"></script>
</body>
</html>
